


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > LeRepository</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.penguino.data.repositories.bluetooth</a>
</div>

<h1>Coverage Summary for Class: LeRepository (com.penguino.data.repositories.bluetooth)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LeRepository</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LeRepository$Companion</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LeRepository$penguinoGattServiceConn$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LeRepository$scanCallback$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LeRepository$scanDevices$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LeRepository$scanDevices$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LeRepository$sendMessage$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/79)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.penguino.data.repositories.bluetooth
&nbsp;
&nbsp;import android.Manifest
&nbsp;import android.bluetooth.BluetoothAdapter
&nbsp;import android.bluetooth.le.ScanCallback
&nbsp;import android.bluetooth.le.ScanResult
&nbsp;import android.content.ComponentName
&nbsp;import android.content.Context
&nbsp;import android.content.Intent
&nbsp;import android.content.IntentFilter
&nbsp;import android.content.ServiceConnection
&nbsp;import android.os.IBinder
&nbsp;import android.util.Log
&nbsp;import androidx.annotation.RequiresPermission
&nbsp;import com.penguino.data.bluetooth.PenguinoGattService
&nbsp;import com.penguino.data.bluetooth.contracts.LeService
&nbsp;import com.penguino.data.bluetooth.receiver.GattConnectionStatusReceiver
&nbsp;import com.penguino.data.local.models.DeviceInfo
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.delay
&nbsp;import kotlinx.coroutines.flow.MutableStateFlow
&nbsp;import kotlinx.coroutines.flow.StateFlow
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.coroutines.withContext
&nbsp;import javax.inject.Inject
&nbsp;
<b class="nc">&nbsp;class LeRepository @Inject constructor(</b>
<b class="nc">&nbsp;	private val context: Context,</b>
<b class="nc">&nbsp;	private val blAdapter: BluetoothAdapter,</b>
&nbsp;) : DeviceConnectionRepository, DeviceDiscoveryRepository {
&nbsp;	private var bleService: LeService? = null
<b class="nc">&nbsp;	private val statusReceiver = GattConnectionStatusReceiver()</b>
<b class="nc">&nbsp;	override val connectionState = statusReceiver.connectionStatus</b>
<b class="nc">&nbsp;	private val scanner = blAdapter.bluetoothLeScanner</b>
<b class="nc">&nbsp;	private var latestScanId: Long = -1L</b>
&nbsp;
<b class="nc">&nbsp;	private var _scanning = MutableStateFlow(false)</b>
<b class="nc">&nbsp;	override var scanning: StateFlow&lt;Boolean&gt; = _scanning</b>
&nbsp;
<b class="nc">&nbsp;	private var _btEnabled = MutableStateFlow(true)</b>
<b class="nc">&nbsp;	override var btEnabled: StateFlow&lt;Boolean&gt; = _btEnabled</b>
&nbsp;
&nbsp;	// Devices found during the scanning process. (Needs a little more tweak)
<b class="nc">&nbsp;	private val mutDeviceSet: MutableSet&lt;DeviceInfo&gt; = mutableSetOf()</b>
<b class="nc">&nbsp;	private val _deviceList = MutableStateFlow&lt;List&lt;DeviceInfo&gt;&gt;(listOf())</b>
<b class="nc">&nbsp;	override val deviceList: StateFlow&lt;List&lt;DeviceInfo&gt;&gt; = _deviceList</b>
&nbsp;
&nbsp;	// Callbacks for binding BluetoothLeService
<b class="nc">&nbsp;	private val penguinoGattServiceConn = object : ServiceConnection {</b>
&nbsp;		override fun onServiceConnected(name: ComponentName?, service: IBinder?) {
<b class="nc">&nbsp;			Log.i(TAG, &quot;Registering broadcast receiver&quot;)</b>
<b class="nc">&nbsp;			context.registerReceiver(statusReceiver, IntentFilter().apply {</b>
<b class="nc">&nbsp;				addAction(PenguinoGattService.ACTION_GATT_CONNECTING)</b>
<b class="nc">&nbsp;				addAction(PenguinoGattService.ACTION_GATT_CONNECTED)</b>
<b class="nc">&nbsp;				addAction(PenguinoGattService.ACTION_GATT_DISCONNECTING)</b>
<b class="nc">&nbsp;				addAction(PenguinoGattService.ACTION_GATT_DISCONNECTED)</b>
<b class="nc">&nbsp;			}, Context.RECEIVER_NOT_EXPORTED)</b>
&nbsp;
<b class="nc">&nbsp;			try {</b>
<b class="nc">&nbsp;				bleService = (service as PenguinoGattService.BtServiceBinder)</b>
<b class="nc">&nbsp;					.getService(blAdapter)</b>
<b class="nc">&nbsp;			} catch (e: IllegalStateException) {</b>
<b class="nc">&nbsp;				Log.e(TAG, &quot;Unable to initialize service&quot;)</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		// TODO: LORD, WHY IS THIS NOT GETTING CALLED!?
&nbsp;		override fun onServiceDisconnected(name: ComponentName?) {
<b class="nc">&nbsp;			Log.i(TAG, &quot;Unbinding status receiver&quot;)</b>
<b class="nc">&nbsp;			context.unregisterReceiver(statusReceiver)</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;Service Unbound&quot;)</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	override fun bindService() {
<b class="nc">&nbsp;		Intent(context, PenguinoGattService::class.java).also { intent -&gt;</b>
<b class="nc">&nbsp;			val bindSuccess: Boolean = context.bindService(</b>
<b class="nc">&nbsp;				intent,</b>
<b class="nc">&nbsp;				penguinoGattServiceConn,</b>
<b class="nc">&nbsp;				Context.BIND_AUTO_CREATE</b>
&nbsp;			)
<b class="nc">&nbsp;			if (!bindSuccess) {</b>
<b class="nc">&nbsp;				unbindService()</b>
&nbsp;			}
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	override fun unbindService() {
<b class="nc">&nbsp;		Intent(context, PenguinoGattService::class.java).also {</b>
<b class="nc">&nbsp;			context.stopService(it)</b>
<b class="nc">&nbsp;			context.unbindService(penguinoGattServiceConn)</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@RequiresPermission(value = Manifest.permission.BLUETOOTH_CONNECT)
<b class="nc">&nbsp;	override suspend fun sendMessage(message: String): Unit = withContext(Dispatchers.IO) {</b>
<b class="nc">&nbsp;		bleService?.write(message)</b>
&nbsp;	}
&nbsp;
&nbsp;	@RequiresPermission(value = Manifest.permission.BLUETOOTH_CONNECT)
&nbsp;	override fun connect(address: String): Boolean {
<b class="nc">&nbsp;		bleService?.connect(address)</b>
<b class="nc">&nbsp;		return true</b>
&nbsp;	}
&nbsp;
&nbsp;	@RequiresPermission(value = Manifest.permission.BLUETOOTH_CONNECT)
&nbsp;	override fun disconnect() {
<b class="nc">&nbsp;		bleService?.disconnect()</b>
&nbsp;	}
&nbsp;
&nbsp;	override fun btEnabled(): Boolean {
<b class="nc">&nbsp;		return blAdapter.isEnabled</b>
&nbsp;	}
&nbsp;
&nbsp;
<b class="nc">&nbsp;	private val scanCallback = object : ScanCallback() {</b>
&nbsp;		@RequiresPermission(value = Manifest.permission.BLUETOOTH_CONNECT)
&nbsp;		override fun onScanResult(callbackType: Int, result: ScanResult?) {
<b class="nc">&nbsp;			super.onScanResult(callbackType, result)</b>
<b class="nc">&nbsp;			result?.device?.let { device -&gt;</b>
<b class="nc">&nbsp;				device.name?.let { name -&gt;</b>
&nbsp;//                    if (name.lowercase() != &quot;penguino&quot;) return
&nbsp;
<b class="nc">&nbsp;					val deviceInfo = DeviceInfo(deviceName = name, address = device.address)</b>
&nbsp;
<b class="nc">&nbsp;					mutDeviceSet.add(deviceInfo)</b>
<b class="nc">&nbsp;					_deviceList.value = mutDeviceSet.toList()</b>
&nbsp;
<b class="nc">&nbsp;					Log.d(&quot;DeviceDiscovery&quot;, deviceList.value.toString())</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		override fun onBatchScanResults(results: MutableList&lt;ScanResult&gt;?) {
<b class="nc">&nbsp;			super.onBatchScanResults(results)</b>
<b class="nc">&nbsp;			Log.d(TAG, results.toString())</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;	@RequiresPermission(value = Manifest.permission.BLUETOOTH_SCAN)
<b class="nc">&nbsp;	override suspend fun scanDevices(durationMillis: Long) = withContext(Dispatchers.Default) {</b>
<b class="nc">&nbsp;		Log.d(&quot;Scanner&quot;, &quot;${scanner == null}&quot;)</b>
<b class="nc">&nbsp;		if (scanning.value) return@withContext</b>
<b class="nc">&nbsp;		val latestId = System.currentTimeMillis()</b>
&nbsp;
<b class="nc">&nbsp;		mutDeviceSet.clear()</b>
<b class="nc">&nbsp;		_deviceList.value = mutDeviceSet.toList()</b>
&nbsp;
<b class="nc">&nbsp;		_scanning.value = true</b>
<b class="nc">&nbsp;		latestScanId = latestId</b>
<b class="nc">&nbsp;		scanner.startScan(scanCallback)</b>
&nbsp;
&nbsp;		// Don&#39;t stop Scanning if there&#39;s a new scan id (Feels like mutexes...)
<b class="nc">&nbsp;		launch {</b>
<b class="nc">&nbsp;			delay(durationMillis)</b>
<b class="nc">&nbsp;			if (_scanning.value &amp;&amp; latestId &gt;= latestScanId) {</b>
<b class="nc">&nbsp;				stopScan()</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@RequiresPermission(value = Manifest.permission.BLUETOOTH_SCAN)
&nbsp;	override fun stopScan() {
<b class="nc">&nbsp;		scanner.stopScan(scanCallback)</b>
<b class="nc">&nbsp;		_scanning.value = false</b>
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	companion object {</b>
&nbsp;		private const val TAG = &quot;LeRepository&quot;
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-08-24 12:14</div>
</div>
</body>
</html>
