


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ChatRepositoryImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.penguino.data.repositories.chat</a>
</div>

<h1>Coverage Summary for Class: ChatRepositoryImpl (com.penguino.data.repositories.chat)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ChatRepositoryImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ChatRepositoryImpl$chatCallback$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChatRepositoryImpl$Companion</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.penguino.data.repositories.chat
&nbsp;
&nbsp;import android.util.Log
&nbsp;import com.penguino.data.models.ChatMessage
&nbsp;import com.penguino.data.network.ChatNetworkDataSource
&nbsp;import com.penguino.data.network.models.ChatRequest
&nbsp;import com.penguino.data.network.models.ChatResponse
&nbsp;import com.penguino.data.utils.FocusedList
&nbsp;import kotlinx.coroutines.flow.MutableStateFlow
&nbsp;import kotlinx.coroutines.flow.StateFlow
&nbsp;import retrofit2.Call
&nbsp;import retrofit2.Callback
&nbsp;import retrofit2.Response
&nbsp;import javax.inject.Inject
&nbsp;
<b class="nc">&nbsp;class ChatRepositoryImpl @Inject constructor(</b>
<b class="nc">&nbsp;	private val chatNetworkDataSource: ChatNetworkDataSource,</b>
&nbsp;): ChatRepository {
&nbsp;	private var systemMsg: ChatMessage? = null
<b class="nc">&nbsp;	private val _history = FocusedList&lt;ChatMessage&gt;(20)</b>
<b class="nc">&nbsp;	override val history = _history.history</b>
<b class="nc">&nbsp;	private val _latestResponse = MutableStateFlow&lt;ChatMessage?&gt;(null)</b>
<b class="nc">&nbsp;	override val latestResponse: StateFlow&lt;ChatMessage?&gt; = _latestResponse</b>
<b class="nc">&nbsp;	private val chatCallback = object: Callback&lt;ChatResponse&gt; {</b>
&nbsp;		override fun onResponse(
&nbsp;			call: Call&lt;ChatResponse&gt;,
&nbsp;			response: Response&lt;ChatResponse&gt;
&nbsp;		) {
<b class="nc">&nbsp;			if (response.isSuccessful) {</b>
<b class="nc">&nbsp;				response.body()?.choices?.first()?.message?.let { message -&gt;</b>
<b class="nc">&nbsp;					Log.i(TAG, message.content)</b>
<b class="nc">&nbsp;					_history.addEntry(listOf(message))</b>
<b class="nc">&nbsp;					_latestResponse.value = message</b>
<b class="nc">&nbsp;				}</b>
&nbsp;			} else {
<b class="nc">&nbsp;				Log.e(TAG, &quot;Error code: ${response.code()}\nMessage: ${response.errorBody()}&quot;)</b>
&nbsp;			}
&nbsp;		}
&nbsp;		override fun onFailure(call: Call&lt;ChatResponse&gt;, t: Throwable) {
<b class="nc">&nbsp;			Log.e(TAG, t.message.toString())</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	override fun setSystemMessage(message: String) {
<b class="nc">&nbsp;		systemMsg = ChatMessage(</b>
<b class="nc">&nbsp;			role = ChatMessage.SYSTEM,</b>
<b class="nc">&nbsp;			content = message</b>
&nbsp;		)
&nbsp;	}
&nbsp;
&nbsp;	override fun chat(
&nbsp;		system: String?,
&nbsp;		message: String,
&nbsp;	) {
<b class="nc">&nbsp;		val messages = mutableListOf&lt;ChatMessage&gt;()</b>
&nbsp;
&nbsp;		// update the system message if necessary
<b class="nc">&nbsp;		system?.let {</b>
<b class="nc">&nbsp;			setSystemMessage(it)</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// append the system message if not null
&nbsp;		// history must only contain back and forth between user and assistant
<b class="nc">&nbsp;		systemMsg?.let {</b>
<b class="nc">&nbsp;			messages += it</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		_history.addEntry(listOf(</b>
<b class="nc">&nbsp;			ChatMessage(</b>
<b class="nc">&nbsp;				content = message</b>
&nbsp;			)
&nbsp;		))
<b class="nc">&nbsp;		messages += _history.getChunk()</b>
&nbsp;
<b class="nc">&nbsp;		chatNetworkDataSource.sendMessage(</b>
<b class="nc">&nbsp;			ChatRequest(</b>
<b class="nc">&nbsp;				model = &quot;gpt-3.5-turbo&quot;,</b>
<b class="nc">&nbsp;				messages = messages</b>
&nbsp;			)
<b class="nc">&nbsp;		).enqueue(chatCallback)</b>
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	companion object {</b>
&nbsp;		const val TAG = &quot;OPENAI&quot;
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-08-24 12:14</div>
</div>
</body>
</html>
