


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ImageCaptureKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.penguino.ui.components</a>
</div>

<h1>Coverage Summary for Class: ImageCaptureKt (com.penguino.ui.components)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ImageCaptureKt</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$4</td>
  </tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$cameraPermission$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$cameraPermission$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$cameraPermission$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ImageCaptureKt$ImageCapture$launchCamera$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.penguino.ui.components
&nbsp;
&nbsp;import android.Manifest
&nbsp;import android.graphics.Bitmap
&nbsp;import android.graphics.BitmapFactory
&nbsp;import android.graphics.Matrix
&nbsp;import android.net.Uri
&nbsp;import androidx.activity.compose.rememberLauncherForActivityResult
&nbsp;import androidx.activity.result.contract.ActivityResultContracts
&nbsp;import androidx.compose.foundation.Image
&nbsp;import androidx.compose.foundation.background
&nbsp;import androidx.compose.foundation.clickable
&nbsp;import androidx.compose.foundation.layout.Arrangement
&nbsp;import androidx.compose.foundation.layout.Box
&nbsp;import androidx.compose.foundation.layout.Column
&nbsp;import androidx.compose.foundation.layout.fillMaxSize
&nbsp;import androidx.compose.foundation.shape.RoundedCornerShape
&nbsp;import androidx.compose.material.icons.Icons
&nbsp;import androidx.compose.material.icons.filled.Add
&nbsp;import androidx.compose.material3.Icon
&nbsp;import androidx.compose.runtime.Composable
&nbsp;import androidx.compose.runtime.getValue
&nbsp;import androidx.compose.runtime.mutableStateOf
&nbsp;import androidx.compose.runtime.remember
&nbsp;import androidx.compose.runtime.rememberCoroutineScope
&nbsp;import androidx.compose.runtime.setValue
&nbsp;import androidx.compose.ui.Alignment
&nbsp;import androidx.compose.ui.Modifier
&nbsp;import androidx.compose.ui.draw.clip
&nbsp;import androidx.compose.ui.graphics.Color
&nbsp;import androidx.compose.ui.graphics.asImageBitmap
&nbsp;import androidx.compose.ui.layout.ContentScale
&nbsp;import androidx.compose.ui.platform.LocalContext
&nbsp;import androidx.core.content.FileProvider
&nbsp;import androidx.exifinterface.media.ExifInterface
&nbsp;import com.penguino.data.models.Image
&nbsp;import com.penguino.data.models.forms.PetRegistrationForm
&nbsp;import kotlinx.coroutines.CoroutineScope
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.coroutines.withContext
&nbsp;import java.io.File
&nbsp;
&nbsp;@Composable
&nbsp;fun ImageCapture(
<b class="nc">&nbsp;	modifier: Modifier = Modifier,</b>
<b class="nc">&nbsp;	registrationForm: PetRegistrationForm = PetRegistrationForm(),</b>
<b class="nc">&nbsp;	scope: CoroutineScope = rememberCoroutineScope(),</b>
<b class="nc">&nbsp;	pfp: Image? = null,</b>
<b class="nc">&nbsp;	onPfpChange: (Image?) -&gt; Unit = {}</b>
<b class="nc">&nbsp;) {</b>
<b class="nc">&nbsp;	val context = LocalContext.current</b>
<b class="nc">&nbsp;	val dataDir = LocalContext.current.dataDir</b>
<b class="nc">&nbsp;	val cacheDir = LocalContext.current.cacheDir</b>
<b class="nc">&nbsp;	val filesDir = LocalContext.current.filesDir</b>
&nbsp;
<b class="nc">&nbsp;	var tempImageCache by remember { mutableStateOf(Uri.EMPTY) }</b>
<b class="nc">&nbsp;	val launchCamera = rememberLauncherForActivityResult(</b>
<b class="nc">&nbsp;		contract = ActivityResultContracts.TakePicture(),</b>
&nbsp;		onResult = { success -&gt;
<b class="nc">&nbsp;			if (success) {</b>
<b class="nc">&nbsp;				tempImageCache?.path?.let { path -&gt;</b>
<b class="nc">&nbsp;					val file = File(dataDir, path)</b>
<b class="nc">&nbsp;					val image = BitmapFactory.decodeFile(file.path).let { decoded -&gt;</b>
<b class="nc">&nbsp;						val rotation = file.inputStream().use { iStream -&gt;</b>
&nbsp;							// Get image orientation in EXIF and return rotation amount
<b class="nc">&nbsp;							ExifInterface(iStream).getAttributeInt(</b>
<b class="nc">&nbsp;								ExifInterface.TAG_ORIENTATION,</b>
<b class="nc">&nbsp;								ExifInterface.ORIENTATION_UNDEFINED</b>
<b class="nc">&nbsp;							).let { orientation -&gt;</b>
<b class="nc">&nbsp;								when (orientation) {</b>
<b class="nc">&nbsp;									ExifInterface.ORIENTATION_ROTATE_90 -&gt; 90f</b>
<b class="nc">&nbsp;									ExifInterface.ORIENTATION_ROTATE_180 -&gt; 180f</b>
<b class="nc">&nbsp;									ExifInterface.ORIENTATION_ROTATE_270 -&gt; 270f</b>
<b class="nc">&nbsp;									else -&gt; 0f</b>
&nbsp;								}
&nbsp;							}
&nbsp;						}
<b class="nc">&nbsp;						val matrix = Matrix().apply { postRotate(rotation) }</b>
<b class="nc">&nbsp;						val bitmap = Bitmap.createBitmap(</b>
<b class="nc">&nbsp;							decoded, 0, 0, decoded.width, decoded.height,</b>
<b class="nc">&nbsp;							matrix, true</b>
&nbsp;						)
<b class="nc">&nbsp;						Image(</b>
<b class="nc">&nbsp;							filePath = &quot;${filesDir}/${registrationForm.device.address}.jpg&quot;,</b>
<b class="nc">&nbsp;							bitmap = bitmap</b>
&nbsp;						)
&nbsp;					}
&nbsp;
<b class="nc">&nbsp;					onPfpChange(image)</b>
<b class="nc">&nbsp;					file.delete()  // Delete temp file after getting the bitmap</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;	)
<b class="nc">&nbsp;	val cameraPermission = rememberLauncherForActivityResult(</b>
<b class="nc">&nbsp;		contract = ActivityResultContracts.RequestPermission(),</b>
&nbsp;		onResult = { grant -&gt;
<b class="nc">&nbsp;			if (grant) {</b>
<b class="nc">&nbsp;				scope.launch {</b>
<b class="nc">&nbsp;					withContext(Dispatchers.IO) {</b>
<b class="nc">&nbsp;						File.createTempFile(&quot;pfp_cache&quot;, &quot;.jpg&quot;, cacheDir)</b>
<b class="nc">&nbsp;					}.let {</b>
<b class="nc">&nbsp;						tempImageCache = FileProvider.getUriForFile(</b>
<b class="nc">&nbsp;							context, &quot;com.penguino.FileProvider&quot;, it</b>
&nbsp;						)
<b class="nc">&nbsp;						launchCamera.launch(tempImageCache)</b>
<b class="nc">&nbsp;					}</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;	)
&nbsp;
<b class="nc">&nbsp;	Box(</b>
<b class="nc">&nbsp;		modifier = Modifier</b>
<b class="nc">&nbsp;			.clip(RoundedCornerShape(100))</b>
<b class="nc">&nbsp;			.clickable {</b>
<b class="nc">&nbsp;				cameraPermission.launch(Manifest.permission.CAMERA)</b>
&nbsp;			}
<b class="nc">&nbsp;			.then(modifier)</b>
&nbsp;	) {
<b class="nc">&nbsp;		Column(</b>
<b class="nc">&nbsp;			modifier = Modifier</b>
<b class="nc">&nbsp;				.background(Color.Gray)</b>
<b class="nc">&nbsp;				.fillMaxSize(),</b>
<b class="nc">&nbsp;			horizontalAlignment = Alignment.CenterHorizontally,</b>
<b class="nc">&nbsp;			verticalArrangement = Arrangement.Center</b>
&nbsp;		) {
<b class="nc">&nbsp;			pfp?.let { image -&gt;</b>
<b class="nc">&nbsp;				Image(</b>
<b class="nc">&nbsp;					modifier = Modifier.fillMaxSize(),</b>
<b class="nc">&nbsp;					bitmap = image.bitmap.asImageBitmap(),</b>
<b class="nc">&nbsp;					contentDescription = &quot;preview&quot;,</b>
<b class="nc">&nbsp;					contentScale = ContentScale.Crop</b>
&nbsp;				)
<b class="nc">&nbsp;			} ?: Icon(imageVector = Icons.Default.Add, contentDescription = &quot;add&quot;)</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;	}</b>
<b class="nc">&nbsp;}</b>
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-08-24 12:14</div>
</div>
</body>
</html>
